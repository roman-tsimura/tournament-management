<div class="tournament-container">
  <!-- List Tournaments View -->
  @if (currentView === 'list') {
  <div class="tournament-list">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Tournaments</h2>
      <button class="btn btn-primary" (click)="createNewTournament()" [disabled]="isLoading">
        <i class="bi" [ngClass]="isLoading ? 'bi-arrow-repeat spin' : 'bi-plus-circle'"></i>
        {{ isLoading ? 'Loading...' : 'Create New Tournament' }}
      </button>
    </div>

    @if (isLoading) {
    <div class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading tournaments...</span>
      </div>
      <p class="mt-2">Loading tournaments, please wait...</p>
    </div>
    } @else if (tournaments.length === 0) {
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      No tournaments found. Create a new tournament to get started!
    </div>
    }

    @if (!isLoading && tournaments.length > 0) {
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Created</th>
              <th>Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (tournament of tournaments | slice: (page-1) * pageSize : (page-1) * pageSize + pageSize; track tournament.id) {
            <tr>
              <td>{{ tournament.name }}</td>
              <td>
                <span class="badge" 
                      [ngClass]="{
                        'bg-warning': tournament.status === 'pending',
                        'bg-primary': tournament.status === 'in_progress',
                        'bg-success': tournament.status === 'completed'
                      }">
                  {{ tournament.status | titlecase }}
                </span>
              </td>
              <td>{{ tournament.createdAt | date:'medium' }}</td>
              <td>{{ tournament.updatedAt | date:'medium' }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-2" 
                        (click)="viewTournament(tournament.id)">
                  View
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      } @else {
      <table class="table table-hover d-none">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Created</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="alert alert-info">
        No tournaments found. Create a new tournament to get started!
      </div>
      }
    </div>
    @if (tournaments.length > 0 && collectionSize > pageSize) {
    <div class="d-flex justify-content-center mt-3">
      <ngb-pagination 
        [(page)]="page" 
        [pageSize]="pageSize" 
        [collectionSize]="collectionSize"
        [maxSize]="5"
        [rotate]="true"
        [ellipses]="false"
        [boundaryLinks]="true">
      </ngb-pagination>
    </div>
    }
  }

  <!-- Create Tournament View -->
  @if (currentView === 'create') {
  <div class="create-tournament">
    <div class="d-flex align-items-center mb-4">
      <button class="btn btn-link p-0 me-3" (click)="onBackToList()">
        <i class="bi bi-arrow-left"></i> Back to List
      </button>
      <h2 class="mb-0">Create New Tournament</h2>
    </div>
    <form [formGroup]="tournamentForm" (ngSubmit)="createTournament()" class="needs-validation" novalidate>
      <div class="form-group">
        <label for="tournamentName">Tournament Name</label>
        <input 
          type="text" 
          id="tournamentName" 
          formControlName="name" 
          class="form-control"
          placeholder="Enter tournament name"
          required>
      </div>

      <div class="form-group">
        <label>Team Assignment</label>
        <div class="form-check">
          <input 
            type="radio" 
            id="teamFixed" 
            formControlName="teamAssignment" 
            value="fixed" 
            class="form-check-input">
          <label for="teamFixed" class="form-check-label">Fixed teams for all games</label>
        </div>
        <div class="form-check">
          <input 
            type="radio" 
            id="teamRandom" 
            formControlName="teamAssignment" 
            value="random" 
            class="form-check-input">
          <label for="teamRandom" class="form-check-label">Random teams for each game</label>
        </div>
      </div>

      <div class="form-group">
        <label>Home/Away Assignment</label>
        <div class="form-check">
          <input 
            type="radio" 
            id="homeAwayFixed" 
            formControlName="homeAwayAssignment" 
            value="fixed" 
            class="form-check-input">
          <label for="homeAwayFixed" class="form-check-label">Fixed home/away for all games</label>
        </div>
        <div class="form-check">
          <input 
            type="radio" 
            id="homeAwayRandom" 
            formControlName="homeAwayAssignment" 
            value="random" 
            class="form-check-input">
          <label for="homeAwayRandom" class="form-check-label">Random home/away for each game</label>
        </div>
      </div>

      <div class="form-group">
        <label for="roundsToPlay">Number of Rounds</label>
        <input 
          type="number" 
          id="roundsToPlay" 
          formControlName="roundsToPlay" 
          class="form-control"
          min="1"
          required>
      </div>

      <div class="players-selection">
        <h4>Select Players (min 2)</h4>
        <div class="players-list">
          <div 
            *ngFor="let player of players" 
            class="player-item"
            [class.selected]="player.id !== undefined && isPlayerSelected(player.id)"
            (click)="player.id !== undefined && togglePlayerSelection(player.id)">
            {{ player.name }}
          </div>
        </div>
      </div>

      <button 
        type="submit" 
        class="btn btn-primary"
        [disabled]="tournamentForm.invalid || selectedPlayers.length < 2 || isLoading">
        {{ isLoading ? 'Creating...' : 'Continue to Team Selection' }}
      </button>
    </form>
  </div>
  }

  <!-- Teams Selection View -->
  @if (currentView === 'teams') {
  <div class="team-selection">
    <h2>Team Selection</h2>
    <p>Select teams and home/away for each player</p>
    
    <div class="player-selections">
      @for (selection of playerSelections; track selection.playerId) {
    <div class="player-selection">
        <div class="player-info">
          <h4>{{ getPlayerName(selection.playerId) }}</h4>
        </div>
        
        <div class="form-group">
          <label>Team</label>
          <select 
            [(ngModel)]="selection.teamId" 
            [ngModelOptions]="{standalone: true}"
            class="form-control">
            <option value="">Select a team</option>
            <option *ngFor="let team of teams" [value]="team.id">{{ team.name }}</option>
          </select>
        </div>
        
        <div class="form-group" *ngIf="tournamentForm.get('homeAwayAssignment')?.value === 'fixed'">
          <label>Home/Away</label>
          <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-outline-primary" [class.active]="selection.isHome">
              <input 
                type="radio" 
                name="homeAway_{{selection.playerId}}" 
                [value]="true" 
                [(ngModel)]="selection.isHome"
                [ngModelOptions]="{standalone: true}"> Home
            </label>
            <label class="btn btn-outline-primary" [class.active]="!selection.isHome">
              <input 
                type="radio" 
                name="homeAway_{{selection.playerId}}" 
                [value]="false" 
                [(ngModel)]="selection.isHome"
                [ngModelOptions]="{standalone: true}"> Away
            </label>
          </div>
        </div>
      </div>
    }
    
    <div class="form-actions">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="currentView = 'create'">
        Back
      </button>
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="finalizeTournamentCreation()"
        [disabled]="hasEmptyTeamSelections() || isLoading">
        {{ isLoading ? 'Creating...' : 'Create Tournament' }}
      </button>
    </div>
  </div>
  </div>
  }

  <!-- Tournament Detail View -->
  @if (currentView === 'tournament' && currentTournament) {
  <div class="tournament-view">
    <div class="tournament-header">
      <h2>{{ currentTournament.name }}</h2>
      <div class="tournament-actions">
        <button class="btn btn-primary" (click)="startNewRound()">
          Start New Round
        </button>
        <button class="btn btn-danger ml-2" (click)="finishTournament()">
          Finish Tournament
        </button>
      </div>
    </div>

    <div class="tournament-stats" *ngIf="stats">
      <div class="stats-summary">
        <div class="stat-item">
          <span class="stat-label">Total Games:</span>
          <span class="stat-value">{{ stats.totalGames }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Completed Games:</span>
          <span class="stat-value">{{ stats.completedGames }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Current Round:</span>
          <span class="stat-value">{{ stats.currentRound }}</span>
        </div>
      </div>

      <h3>Leaderboard</h3>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>P</th>
              <th>W</th>
              <th>D</th>
              <th>L</th>
              <th>GF</th>
              <th>GA</th>
              <th>GD</th>
              <th>Pts</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let player of stats.leaderboard; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ getPlayerName(player.playerId) }}</td>
              <td>{{ player.gamesPlayed }}</td>
              <td>{{ player.wins }}</td>
              <td>{{ player.draws }}</td>
              <td>{{ player.losses }}</td>
              <td>{{ player.goalsScored }}</td>
              <td>{{ player.goalsConceded }}</td>
              <td>{{ player.goalsScored - player.goalsConceded }}</td>
              <td><strong>{{ player.totalPoints }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="rounds-container" *ngIf="currentTournament.rounds.length > 0">
      <h3>Rounds</h3>
      <div *ngFor="let round of currentTournament.rounds" class="round">
        <h4>Round {{ round.roundNumber }}</h4>
        <div class="games-list">
          <div *ngFor="let game of round.games" class="game-card" (click)="playGame(game)">
            <div class="teams">
              <div class="team home-team">
                <span class="team-name">{{ getPlayerName(game.homePlayer.playerId) }}</span>
                <span class="team-badge">{{ getTeamName(game.homePlayer.teamId) }}</span>
                <span class="score" *ngIf="game.isCompleted">{{ game.homeScore }}</span>
              </div>
              <div class="vs">vs</div>
              <div class="team away-team">
                <span class="team-name">{{ getPlayerName(game.guestPlayer.playerId) }}</span>
                <span class="team-badge">{{ getTeamName(game.guestPlayer.teamId) }}</span>
                <span class="score" *ngIf="game.isCompleted">{{ game.guestScore }}</span>
              </div>
            </div>
            <div class="game-status" [class.completed]="game.isCompleted">
              {{ game.isCompleted ? 'Completed' : 'Click to play' }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Game View -->
  @if (currentView === 'game' && currentGame) {
  <div class="game-view">
    <div class="game-header">
      <h2>Game {{ currentGame.id }}</h2>
      <div class="round-info">Round {{ currentRound }} of {{ currentTournament?.settings?.roundsToPlay || 1 }}</div>
    </div>
    
    <form [formGroup]="scoreForm" (ngSubmit)="submitGameScore()" class="game-form">
      <div class="game-teams">
        <div class="team home-team">
          <h3>{{ getPlayerName(currentGame.homePlayer.playerId) }}</h3>
          <div class="team-info">
            <span class="team-badge">{{ getTeamName(currentGame.homePlayer.teamId) }}</span>
            <span class="home-label">(Home)</span>
          </div>
          <div class="score-input">
            <input 
              type="number" 
              formControlName="homeScore"
              min="0" 
              class="form-control"
              placeholder="0"
              required>
          </div>
        </div>
        
        <div class="vs">vs</div>
        
        <div class="team away-team">
          <h3>{{ getPlayerName(currentGame.guestPlayer.playerId) }}</h3>
          <div class="team-info">
            <span class="team-badge">{{ getTeamName(currentGame.guestPlayer.teamId) }}</span>
            <span class="away-label">(Away)</span>
          </div>
          <div class="score-input">
            <input 
              type="number" 
              formControlName="awayScore"
              min="0" 
              class="form-control"
              placeholder="0"
              required>
          </div>
        </div>
      </div>
      
      <div class="game-actions mt-4">
        <button 
          type="button"
          class="btn btn-secondary me-2" 
          (click)="cancelGame()">
          Cancel
        </button>
        <button 
          type="submit"
          class="btn btn-primary" 
          [disabled]="scoreForm.invalid || isLoading">
          @if (!isLoading) {
          <span>Save Score</span>
          } @else {
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          }
        </button>
      </div>
    </form>
    
    @if (currentTournament) {
    <div class="game-progress mt-4">
      <div class="progress">
        <div 
          class="progress-bar progress-bar-striped progress-bar-animated" 
          role="progressbar" 
          [style.width]="(getCompletedGamesCount() / getTotalGamesCount() * 100) + '%'"
          [attr.aria-valuenow]="getCompletedGamesCount()"
          [attr.aria-valuemin]="0"
          [attr.aria-valuemax]="getTotalGamesCount()">
          {{ getCompletedGamesCount() }} / {{ getTotalGamesCount() }} games
        </div>
      </div>
      <div class="progress-text text-center mt-2">
        <strong>Round {{ currentRound }} Progress</strong>
      </div>
    </div>
    }
  </div>
  }
</div>